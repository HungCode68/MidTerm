pipeline {
    agent any

    environment {
        IMAGE_NAME = 'hungcode68/finalterm'
        IMAGE_TAG = 'latest'
        CONTAINER_NAME = 'vinfastsystem_container'
        DOCKERHUB_CREDENTIALS = 'dockerhub-credentials'
        TOMCAT_PATH = 'C:\\apache-tomcat-10.1.41'
    }

    stages {
        stage('üîÑ Clone Repository') {
            steps {
                echo 'üì• Cloning source code from GitHub...'
                git branch: 'main', url: 'https://github.com/HungCode68/MidTerm.git'
            }
        }

        stage('üßπ Clean & Prepare') {
            steps {
                echo 'üßπ Cleaning and preparing build environment...'
                bat '''
                    if exist build rmdir /s /q build
                    if exist dist rmdir /s /q dist
                    mkdir build
                    mkdir dist
                    mkdir build\\WEB-INF
                    mkdir build\\WEB-INF\\classes
                    mkdir build\\WEB-INF\\lib
                    
                    echo "‚úÖ Build directories created"
                '''
            }
        }

        stage('üìö Verify Libraries') {
            steps {
                echo 'üìö Checking required libraries...'
                bat '''
                    if exist Web\\WEB-INF\\lib (
                        echo "üìã Found libraries:"
                        dir Web\\WEB-INF\\lib
                        
                        REM Check for SQL Server driver
                        dir Web\\WEB-INF\\lib\\*mssql* /B >nul 2>&1
                        if errorlevel 1 (
                            echo "‚ö†Ô∏è  WARNING: SQL Server JDBC driver not found!"
                            echo "Please add mssql-jdbc-*.jar to Web\\WEB-INF\\lib\\"
                        ) else (
                            echo "‚úÖ SQL Server JDBC driver found"
                        )
                    ) else (
                        echo "‚ùå ERROR: Web\\WEB-INF\\lib directory not found!"
                        echo "Please create it and add required JAR files"
                        exit /b 1
                    )
                '''
            }
        }

        stage('üìÇ Copy Resources') {
            steps {
                echo 'üìÇ Copying web resources and libraries...'
                bat '''
                    REM Copy JSP and HTML files
                    for %%f in (Web\\*.jsp Web\\*.html) do (
                        if exist "%%f" copy "%%f" build\\ /Y
                    )
                    
                    REM Copy static resources
                    if exist Web\\css xcopy Web\\css build\\css /E /I /Y
                    if exist Web\\js xcopy Web\\js build\\js /E /I /Y
                    if exist Web\\images xcopy Web\\images build\\images /E /I /Y
                    if exist Web\\assets xcopy Web\\assets build\\assets /E /I /Y
                    if exist Web\\styles xcopy Web\\styles build\\styles /E /I /Y
                    
                    REM Copy WEB-INF content
                    if exist Web\\WEB-INF\\web.xml copy Web\\WEB-INF\\web.xml build\\WEB-INF\\ /Y
                    
                    REM Copy JAR libraries (CRITICAL!)
                    if exist Web\\WEB-INF\\lib\\*.jar (
                        xcopy Web\\WEB-INF\\lib\\*.jar build\\WEB-INF\\lib\\ /Y
                        echo "‚úÖ Libraries copied:"
                        dir build\\WEB-INF\\lib
                    ) else (
                        echo "‚ùå ERROR: No JAR files found in Web\\WEB-INF\\lib\\"
                        exit /b 1
                    )
                '''
            }
        }

        stage('‚öôÔ∏è Compile Java') {
            steps {
                echo '‚öôÔ∏è Compiling Java source files...'
                bat '''
                    REM Build classpath with all JARs
                    SET CLASSPATH=%TOMCAT_PATH%\\lib\\servlet-api.jar
                    for %%i in (build\\WEB-INF\\lib\\*.jar) do (
                        SET CLASSPATH=!CLASSPATH!;%%i
                    )
                    
                    echo "üîß Classpath: %CLASSPATH%"
                    
                    REM Compile all Java files
                    javac -d build\\WEB-INF\\classes -cp "%CLASSPATH%" -sourcepath src ^
                        src\\context\\*.java ^
                        src\\model\\*.java ^
                        src\\dao\\*.java ^
                        src\\controller\\*.java
                    
                    if errorlevel 1 (
                        echo "‚ùå Compilation failed!"
                        exit /b 1
                    ) else (
                        echo "‚úÖ Compilation successful"
                        echo "üìã Compiled classes:"
                        dir build\\WEB-INF\\classes /S /B
                    )
                '''
            }
        }

        stage('üì¶ Create WAR') {
            steps {
                echo 'üì¶ Creating WAR file with proper structure...'
                bat '''
                    cd build
                    
                    REM Create WAR file
                    jar -cvf ..\\dist\\VinfastSystem.war *
                    
                    cd ..
                    
                    REM Verify WAR structure
                    echo "üìã WAR file contents:"
                    jar -tf dist\\VinfastSystem.war | findstr /C:"WEB-INF/classes" /C:"WEB-INF/lib" /C:".jsp" /C:"web.xml"
                    
                    REM Check WAR size
                    for %%A in (dist\\VinfastSystem.war) do echo "üìè WAR size: %%~zA bytes"
                '''
            }
        }

        stage('üöÄ Deploy to Local Tomcat') {
            steps {
                echo 'üöÄ Deploying to local Tomcat for testing...'
                bat '''
                    REM Stop Tomcat gracefully
                    taskkill /f /im java.exe /fi "WINDOWTITLE eq Tomcat" 2>nul || echo "Tomcat not running"
                    timeout /t 5
                    
                    REM Clean old deployment
                    if exist "%TOMCAT_PATH%\\webapps\\VinfastSystem*" (
                        rmdir /s /q "%TOMCAT_PATH%\\webapps\\VinfastSystem" 2>nul
                        del "%TOMCAT_PATH%\\webapps\\VinfastSystem.war" 2>nul
                    )
                    
                    REM Deploy new WAR
                    copy dist\\VinfastSystem.war "%TOMCAT_PATH%\\webapps\\" /Y
                    
                    REM Start Tomcat
                    start "" "%TOMCAT_PATH%\\bin\\startup.bat"
                    
                    echo "‚è≥ Waiting for Tomcat to start..."
                    timeout /t 15
                    
                    echo "‚úÖ Local deployment completed"
                '''
            }
        }

        stage('üê≥ Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                script {
                    def image = docker.build("${IMAGE_NAME}:${IMAGE_TAG}")
                    echo "‚úÖ Docker image built: ${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage('üõë Stop Previous Container') {
            steps {
                echo 'üõë Cleaning up previous container...'
                script {
                    try {
                        bat "docker stop ${CONTAINER_NAME} 2>nul || echo 'No container to stop'"
                        bat "docker rm ${CONTAINER_NAME} 2>nul || echo 'No container to remove'"
                        echo "‚úÖ Previous container cleaned up"
                    } catch (Exception e) {
                        echo "‚ÑπÔ∏è No previous container found"
                    }
                }
            }
        }

        stage('üöÄ Run Docker Container') {
            steps {
                echo 'üöÄ Starting new Docker container...'
                script {
                    // Check if port is available
                    def portCheck = bat(
                        script: 'netstat -ano | findstr :8087',
                        returnStatus: true
                    )
                    
                    if (portCheck == 0) {
                        error "‚ùå Port 8087 is already in use!"
                    }
                    
                    // Run container with proper network configuration
                    bat """docker run -d --name ${CONTAINER_NAME} \
                           -p 8087:8081 \
                           --add-host=host.docker.internal:host-gateway \
                           -e "CATALINA_OPTS=-Ddb.host=host.docker.internal -Xms512m -Xmx1024m" \
                           ${IMAGE_NAME}:${IMAGE_TAG}"""
                    
                    // Wait for container to fully start
                    echo "‚è≥ Waiting for container to start..."
                    sleep(15)
                    
                    // Verify container is running
                    def containerStatus = bat(
                        script: "docker ps -f name=${CONTAINER_NAME} --format '{{.Status}}'",
                        returnStdout: true
                    ).trim()
                    
                    echo "üìä Container status: ${containerStatus}"
                    
                    if (!containerStatus.contains("Up")) {
                        bat "docker logs ${CONTAINER_NAME}"
                        error "‚ùå Container failed to start properly"
                    }
                }
            }
        }

        stage('üîç Health Check') {
            steps {
                echo 'üîç Performing application health check...'
                script {
                    // Wait a bit more for application to fully load
                    sleep(10)
                    
                    // Check container logs for any errors
                    def logs = bat(
                        script: "docker logs ${CONTAINER_NAME} 2>&1",
                        returnStdout: true
                    )
                    
                    if (logs.contains("ERROR") || logs.contains("Exception")) {
                        echo "‚ö†Ô∏è Found errors in container logs:"
                        echo logs
                    } else {
                        echo "‚úÖ No critical errors found in logs"
                    }
                    
                    // Test database connection
                    echo "üîå Testing database connectivity..."
                    echo "   Make sure SQL Server is running and accessible"
                }
            }
        }

        stage('üì§ Push to Docker Hub') {
            when {
                expression { return params.PUSH_TO_DOCKERHUB != false }
            }
            steps {
                echo 'üì§ Pushing image to Docker Hub...'
                script {
                    docker.withRegistry('https://index.docker.io/v1/', DOCKERHUB_CREDENTIALS) {
                        docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push()
                        echo "‚úÖ Image pushed to Docker Hub successfully"
                    }
                }
            }
        }
    }

    post {
        success {
            echo '''
            üéâ ===============================================
            ‚úÖ TRI·ªÇN KHAI TH√ÄNH C√îNG!
            ===============================================
            
            üìç ·ª®ng d·ª•ng ƒë√£ ƒë∆∞·ª£c tri·ªÉn khai t·∫°i:
               ‚Ä¢ Local Tomcat: http://localhost:8081/VinfastSystem
               ‚Ä¢ Docker Container: http://localhost:8087
            
            üîß ƒê·ªÉ ki·ªÉm tra v√† debug:
               ‚Ä¢ Container logs: docker logs vinfastsystem_container
               ‚Ä¢ Container shell: docker exec -it vinfastsystem_container bash
               ‚Ä¢ Tomcat logs: %TOMCAT_PATH%\\logs\\catalina.out
            
            üìã C·∫•u tr√∫c WAR ƒë√£ ƒë∆∞·ª£c t·∫°o ƒë√∫ng chu·∫©n v·ªõi:
               ‚Ä¢ Web resources (JSP, HTML, CSS, JS)
               ‚Ä¢ Compiled Java classes
               ‚Ä¢ JAR libraries (JDBC driver)
               ‚Ä¢ web.xml configuration
            
            ===============================================
            '''
        }
        failure {
            echo '''
            ‚ùå ===============================================
            TRI·ªÇN KHAI TH·∫§T B·∫†I!
            ===============================================
            
            üîç C√°c b∆∞·ªõc debug:
            1. Ki·ªÉm tra logs: docker logs vinfastsystem_container
            2. Ki·ªÉm tra th∆∞ vi·ªán: ls Web/WEB-INF/lib/
            3. Ki·ªÉm tra SQL Server c√≥ ch·∫°y kh√¥ng
            4. Ki·ªÉm tra port 1433 c√≥ m·ªü kh√¥ng
            
            üí° C√°c l·ªói th∆∞·ªùng g·∫∑p:
            ‚Ä¢ Thi·∫øu JDBC driver trong Web/WEB-INF/lib/
            ‚Ä¢ SQL Server kh√¥ng ch·∫°y ho·∫∑c kh√¥ng cho ph√©p TCP/IP
            ‚Ä¢ Port conflict
            ‚Ä¢ Compilation errors
            ===============================================
            '''
            
            // Show container logs if container exists
            script {
                try {
                    bat "docker logs ${CONTAINER_NAME} 2>&1 || echo 'No container logs available'"
                } catch (Exception e) {
                    echo "Could not retrieve container logs"
                }
            }
        }
        always {
            // Clean up build artifacts
            bat 'if exist build rmdir /s /q build 2>nul || echo "Build cleanup completed"'
        }
    }
}